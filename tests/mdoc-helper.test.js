import test from 'node:test';
import assert from 'node:assert/strict';
import { decodeVpToken, verifyDocument } from '../scripts/formats/mdoc-helper.js';

const VP_TOKEN = 'o2d2ZXJzaW9uYzEuMGlkb2N1bWVudHOBo2dkb2NUeXBldW9yZy5pc28uMTgwMTMuNS4xLm1ETGxpc3N1ZXJTaWduZWSiam5hbWVTcGFjZXOhcW9yZy5pc28uMTgwMTMuNS4xg9gYWFSkaGRpZ2VzdElEGCZmcmFuZG9tUIrnZicRdZs3l4bg8hcKX3VxZWxlbWVudElkZW50aWZpZXJqZ2l2ZW5fbmFtZWxlbGVtZW50VmFsdWVlRXJpa2HYGFhZpGhkaWdlc3RJRApmcmFuZG9tUHXomYfgkGBl1bLGF-Gul1BxZWxlbWVudElkZW50aWZpZXJrZmFtaWx5X25hbWVsZWxlbWVudFZhbHVlak11c3Rlcm1hbm7YGFhPpGhkaWdlc3RJRA9mcmFuZG9tUENM7ZfpX0zcYBwHCR8sqlpxZWxlbWVudElkZW50aWZpZXJrYWdlX292ZXJfMjFsZWxlbWVudFZhbHVl9Wppc3N1ZXJBdXRohEOhASahGCFZAo8wggKLMIICEaADAgECAhAoiKVL_PLja2oMNej4i-LyMAoGCCqGSM49BAMDMC4xHzAdBgNVBAMMFk9XRiBNdWx0aXBheiBURVNUIElBQ0ExCzAJBgNVBAYMAlVTMB4XDTI1MDcwOTIwNDgyOFoXDTI2MTAwNzIwNDgyOFowLDEdMBsGA1UEAwwUT1dGIE11bHRpcGF6IFRFU1QgRFMxCzAJBgNVBAYMAlVTMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEfIi_KyKZnmdwSHXWVrPGNlk2QltpL3iVo8sRxm3ES-EuYz1EeslsEcA82uBK13h-iM0ChEqVAdv_qhNohdsPTaOCAREwggENMB8GA1UdIwQYMBaAFKtlG-BWwpBT8d1_bOSHvmjeYMn1MA4GA1UdDwEB_wQEAwIHgDAVBgNVHSUBAf8ECzAJBgcogYxdBQECMEwGA1UdEgRFMEOGQWh0dHBzOi8vZ2l0aHViLmNvbS9vcGVud2FsbGV0LWZvdW5kYXRpb24tbGFicy9pZGVudGl0eS1jcmVkZW50aWFsMFYGA1UdHwRPME0wS6BJoEeGRWh0dHBzOi8vZ2l0aHViLmNvbS9vcGVud2FsbGV0LWZvdW5kYXRpb24tbGFicy9pZGVudGl0eS1jcmVkZW50aWFsL2NybDAdBgNVHQ4EFgQU5951APEkm_F0ALKZ3fW3aHJerMAwCgYIKoZIzj0EAwMDaAAwZQIwY10Za20o-T_Jg_KcoZ9xs6u1u29QaPOVzjnQK-PxnwC49PQwhCPnTd2xeu7rISTwAjEAq9HjVoSSg6ztCrPrToaCB0dXeWfzX2FVH-wzxoKLziFCV1J9C6ZyRR4eHN6hWcmqWQez2BhZB66mZ3ZlcnNpb25jMS4wb2RpZ2VzdEFsZ29yaXRobWdTSEEtMjU2Z2RvY1R5cGV1b3JnLmlzby4xODAxMy41LjEubURMbHZhbHVlRGlnZXN0c6Jxb3JnLmlzby4xODAxMy41LjG4KApYIIcUkLyYwAyUGj7J0LND1-KwzNLZnZ1D_yPvdjv-Ynt1GCZYICaaMVXTIKGTddWkErF0aVa8CdTRCh7KH2BGLKRP1kdNAlgga8MnsHLd4Uy-Zh041GRRxhAy7ejdAsVgEqSnomJVZiMYHlgg4s7cTbu94Pj0UPBcxqUAFBNQO49ZKd8i6P8Cxx8VbfAFWCBgmlvtBAFsnDPMQwHuae4hSKMbphpK_bgR5K-cZ8oZCAdYIMD09Jgp5QuDEGVF4eFHMZLZsExpRJYll4iem8RPF1QHEVggNkp_9SCrCc8WrVsbV83DSYpK1LvpBI89CqVZprtigPUYHFggwWqLzd4_jk5umz12JdQrbK48WpYNin3MbMff0r5whMoSWCAQNCGDNzqRigax4quLUfE9b-BtJlRFHnIJiJFIO8xL5hgrWCDCrPIl-9_k5p1_uGgx9pgKdJ_YsnhfuYW_bI9SkGmGdBgfWCASkD9y5WnH6thXcC0UYWI2qXj_Tofl0IzDZpQDSKXdtQhYIB8ABE0Kzo7k-UQKtvZDIEzOObkSqoQA0ckQeq3GIYanGClYIF4FB1jperLwGAxQW8-I7bGZUubxzyrQYkYei27jThchF1ggV9L4MKodDYIqkDZQAwlmVnfLxpompm53k-tckVhmyY8MWCAkQrltK6h3gGfkCrdOH3oYXXfJKbvnIhkN5633HeJm2BgaWCB7AJebZlGAjX3nooEnS-g_co35YSIlGdGkI5lOsahDeRNYIOoTSRemcMzsC3vdaOeAMVwbja1J3kllbHwBdbYMxnnxGCRYIPugbPMkQ-BkEFGlTuYkf2HAUL19v6c5JeXPtU3x6rPcGCFYIOWsdNzQAINVAi2AkcEg90q-cerm2IDdNTjF-l8qtjemEFgg9j08nDoj84Mcw9FB8yjo6egbHod6p2iIL8KOMWIVMYwYLVggFAAiSrf64PhwF039K0-tc1C2VgR6i88Yncn10TkwUQgYLFggwloah0Q8CWeTqryXiC-sihQzSlIhT9pJX6eT5cQirhYUWCBhcaCWd2D3RlryATS8SV7yAb3g0Oyp0jdeiE_YQLrPexgoWCByrkcSzymKcbHtxtInBMNwv07n2y7xLD70X0v8BPiRLgNYIFK1fH4Zwm2TgGeZdmLYtr2J88UAAwthjIOWJWffW1PAD1gg9AseoxB54DJYk6xNA3HbO-xDpcKe1089cFk2fY-Lfs0YKlggpgY9memQR8Jni_p8g5iBCwyFsJ3gWMIqGEJnF2hXrSAYJ1ggXo6h-yvInSXNLFZ9SWqUH1oynpy2jo6LMzhC47ISJ9QWWCDTGtstEnFkIU0F_xmIYY01OGxBxv4D5EUgrVmhLBi9zxgZWCAvZbxgHCxI0YO2Wd49OSicKi862tJ6xDVnqCta9PDc8wBYII4LU92WrPRLUIhA2eBRv_s8BC-5vqXvmsO1UWoDPHYoC1ggJ7jVY-JUF_KgxgCaY91eWNqRblanBByqWWCHangypksYGFgga3Q0DwWZe0jv3dTsXpdI6ZzbPcJ6z2rz3Luv3lkOOl4OWCCJv-Ug_2lc86LDSwyr_I80fMdLM7CJO_Wt3zjacyX5kRgdWCAAMkPadIZuY3vr35mO9Ri5O_k_F4s8SACgjwITwpFjTQlYIJDdiLRgZ6-W2xX4VWZn6gerun6pu9Tt-HvevNy0-L8TBlgglEmGK-ghuF32KQNE0Duy3R373uaBYafHdUhKpJ3DFJAYIFggqLiPXQxj4yk6sxra2wtSRTGlcFDi4HFqBQSvKVxYthcBWCCf8Q4BBIHTdqZCVLRsrX0ll2gjd646TRphFATCM8YEDg1YIGdy9_8E706gZwfyU7IwND4-KRqYT0ScEENjHcvHMTutd29yZy5pc28uMTgwMTMuNS4xLmFhbXZhphglWCBFHehz5sUQoxVsIdWHJMMu1Z0RQmfpCgMSt2VS1TKJFxgbWCBDNL0QxXcBiao0PmuFE0jSSuJ2QDkl7Ny7Vv3TYsxgBhgiWCBBFgnBilJV_6x45uQirnMtW9VVrsoNriGLO0M6ihA5NxVYIPF1UH5YfWAOMPi7zSkfMU7ikcP1DrrTP3DSEUsK6EwaGCNYINrX4mlZhd3JO862fNdyIVO4_SM5JV2AJkL0DPLxkEk0BFggkkdgVMLJDF91_-vuo_DcUNvkaU4sPf-W3Ga_OAhnC-ltZGV2aWNlS2V5SW5mb6FpZGV2aWNlS2V5pAECIAEhWCBZ7JBaWfcHMX0v0vnBf_0PgDsy6EckHVDS29hP5XkRhSJYIPHiQKhAZnPaYNCtvR0OLLgmsB1aBl1CTCtlPi6gcDXkbHZhbGlkaXR5SW5mb6Nmc2lnbmVkwHQyMDI1LTA3LTEwVDE5OjQ4OjI4Wml2YWxpZEZyb23AdDIwMjUtMDctMTBUMTk6NDg6MjhaanZhbGlkVW50aWzAdDIwMjYtMDctMTBUMjA6NDg6MjhaWEClYJRg_J_uksDG5UQOeXMz5jQ7z0xp1onc2DiGIW1FgoXxPEZ_3ZSRxdtcNFFeYGwbZa42WuolpRgHWtlkOOP_bGRldmljZVNpZ25lZKJqbmFtZVNwYWNlc9gYQaBqZGV2aWNlQXV0aKFvZGV2aWNlU2lnbmF0dXJlhEOhASag9lhAnZEta-ncizbaSBzuFxURqEdsAdv8TUMbzBfUMFNLogUVQO5Va3mDsgk92rRdIMXe8fG9vN09pzEdw2_I_QBdQWZzdGF0dXMA';
const sessionTranscript = new Uint8Array([131, 246, 246, 130, 118, 79, 112, 101, 110, 73, 68, 52, 86, 80, 68, 67, 65, 80, 73, 72, 97, 110, 100, 111, 118, 101, 114, 88, 32, 54, 123, 164, 4, 29, 59, 250, 217, 13, 59, 198, 65, 89, 182, 82, 248, 176, 100, 104, 145, 198, 105, 59, 186, 252, 221, 192, 137, 99, 209, 112, 151]);
test('decodeVpToken', async () => {
    assert.doesNotThrow(async () => {
        const decoded = await decodeVpToken(VP_TOKEN);
        assert.equal(decoded.documents.length, 1);
    });
});

test('verifyDocument', async () => {
        const decoded = await decodeVpToken(VP_TOKEN);
        const verified = await verifyDocument(decoded.documents[0], sessionTranscript);
        assert.equal(verified.claims.given_name, 'Erika');
        assert.equal(verified.claims.family_name, 'Mustermann');
        assert.equal(verified.claims.age_over_21, true);
});